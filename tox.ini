[tox]
envlist = py{38}-{migrate,api,test,testsummary,verify}
skipsdist = True
skip_install = True
basepython =
    3.8: python3.8
envdir =
    3.8: {toxworkdir}/3.8
setenv =
    PYTHONPATH = {toxinidir}
    PYTHONHASHSEED = 0

[testenv]
platform = migrate: linux
           api: linux
           test: linux
           testsummary: linux
           verify: linux
changedir =
    migrate: {toxinidir}/api/alembic
    api: {toxinidir}/api
    test: {toxinidir}/api
    testsummary: {toxinidir}/api
    verify: {toxinidir}/api_verify
passenv = *
deps =
    migrate: sqlalchemy
    migrate: sqlalchemy_utils
    migrate: alembic
    api: -r{toxinidir}/api/requirements.txt
    test: -r{toxinidir}/api/requirements.txt
    test: coverage
    test: coveralls
    test: pytest
    test: pytest-emoji
    test: pytest-html
    test: pytest-md
    test: pytest-repeat
    test: aiofiles
    test: jinja2
    verify: -r{toxinidir}/api_verify/requirements.txt
commands =
    migrate: alembic {posargs}
    test: coverage run -m pytest {posargs}
    test: coverage report -m
    test: coverage html
    test: coverage xml
    testsummary: python3 tests/testing_utils/show_test_reports.py -s {env:SHOW_COV_HTML:True}
    api: gunicorn -w 1 --bind 0.0.0.0:{env:PORT:8050} -k uvicorn.workers.UvicornWorker main:app
    verify: python3 api_handle_invalid_data.py
